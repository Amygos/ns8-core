#!/usr/bin/env python3

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import sys
import json
import agent
import agent.tasks

request = json.load(sys.stdin)
tnode_id = str(request['node_id'])

rdb = agent.redis_connect(privileged=True)

# Delete the node account
rdb.execute_command('ACL', 'DELUSER', 'node/' + tnode_id)
rdb.execute_command('ACL', 'SAVE')

agent.save_acls(rdb)
agent.set_progress(19)

# Delete the target node keyspace
node_keys = set(knode for knode in rdb.scan_iter(f'node/{tnode_id}/*'))
rdb.delete(*node_keys)

# Reconfigure VPN routes of remaining nodes
rdb.publish('cluster/event/vpn-changed', json.dumps({"node_id": tnode_id}))

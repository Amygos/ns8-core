#!/usr/bin/env python3

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: AGPL-3.0-or-later
#

'''
Helper script that retrive cluster info and send them to
the phonehome server
'''

import sys
import json
import agent
import http.client
import cluster.inventory

facts = cluster.inventory.cluster_facts()
if facts:
    facts['modules'] = cluster.inventory.modules_facts()
    facts['cluster'] = cluster.inventory.subscription_fact()
else:
    print(agent.SD_ERR + f"phonehome failed", file=sys.stderr)
    sys.exit(1)

redis_client = agent.redis_connect(privileged=False)
client = http.client.HTTPSConnection(
    redis_client.get('cluster/phonehome/endpoint')
)
client.request('POST', '/api/installation', json.dumps(facts), {
    "Content-type": "application/json",
    "Accept": "application/json"
})
resp = client.getresponse()

if resp.status >= 400:
    print(agent.SD_ERR + f"phonehome failed with status {resp.status}", file=sys.stderr)
    sys.exit(1)

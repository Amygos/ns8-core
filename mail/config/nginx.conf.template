user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log info;
pid /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    log_format auth '$http_auth_protocol $http_auth_user $http_auth_login_attempt $http_client_ip $http_client_host';

    access_log /var/log/nginx/access.log main;
    sendfile on;
    keepalive_timeout 65;

    map $http_auth_protocol $mail_backend_port {
        default imap;
        imap 143;
        pop3 110;
        smtp 587;
    }

    server {
        listen 127.0.0.1:19000;
        server_name mailauth;

        # Anonymous SMTP sessions are sent to Postfix listener
        if ( $http_auth_user = '' ) {
            set $mail_backend_port 25;
        }

        access_log /var/log/nginx/access.log auth;

        location / {
            return 403;
        }

        location = /auth {
            allow 127.0.0.1;
            deny all;
            add_header Auth-Status OK;
            add_header Auth-Server 127.0.0.1;
            add_header Auth-Port $mail_backend_port;
            return 200 '';
        }
    }
}

# L7 proxy for mail services
mail {
    auth_http 127.0.0.1:19000/auth;
    server {
        listen 10025;
        protocol smtp;
        smtp_auth login plain;
        proxy_smtp_auth on;
        xclient on;
    }
    server {
        listen 10110;
        protocol pop3;
    }
    server {
        listen 10143;
        protocol imap;
    }
    server {
        listen 10587;
        protocol smtp;
        smtp_auth login plain;
        proxy_smtp_auth on;
        xclient on;
    }
}

# L4 proxy to the LDAP account provider 
stream {
    server {
        listen 389;
        proxy_pass ${LDAPHOST}:${LDAPPORT};
        proxy_ssl ${LDAPSSL};
    }
}
